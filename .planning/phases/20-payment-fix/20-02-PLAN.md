---
phase: 20-payment-fix
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - "C:/Users/bskim/Downloads/beamacademy-index.html"
autonomous: false

must_haves:
  truths:
    - "Pay Now button triggers Stripe checkout flow"
    - "User can complete a test purchase end-to-end"
    - "Loading state shows while redirecting to Stripe"
    - "Error messages display clearly if checkout fails"
  artifacts:
    - path: "C:/Users/bskim/Downloads/beamacademy-index.html"
      provides: "Frontend with working Pay Now button"
      contains: "handlePayNow"
  key_links:
    - from: "beamacademy-index.html (handlePayNow)"
      to: "/.netlify/functions/create-checkout"
      via: "fetch POST request"
      pattern: "fetch.*create-checkout"
---

<objective>
Connect frontend Pay Now button to Stripe checkout flow and verify end-to-end payment

Purpose: Complete the payment integration so users can pay for term tuition
Output: Working Pay Now button that redirects to Stripe Checkout
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-payment-fix/20-01-SUMMARY.md
@C:/Users/bskim/Downloads/beamacademy-index.html (lines 7570-7650 - handlePayNow function)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify frontend payment flow code</name>
  <files>C:/Users/bskim/Downloads/beamacademy-index.html</files>
  <action>
    Review the existing handlePayNow() function in beamacademy-index.html to verify:
    
    1. Function is properly attached to paySubmitBtn click event
    2. Payload structure matches what create-checkout.js expects:
       - tier, package, subjects, parentName, studentName, email, phone
    3. Loading state is applied during request
    4. Redirect to checkout URL works
    5. Error handling shows user-friendly message
    
    The function already exists around line 7567. Check if:
    - It's reading form values correctly
    - The tier/package parsing from hiddenPackage field works
    - The fetch URL is correct: '/.netlify/functions/create-checkout'
    
    If any issues found, fix them.
  </action>
  <verify>
    - handlePayNow function exists and is attached to button
    - Payload structure matches backend expectations
    - Error handling exists
  </verify>
  <done>Frontend payment code verified and any issues fixed</done>
</task>

<task type="auto">
  <name>Task 2: Add console logging for debugging</name>
  <files>C:/Users/bskim/Downloads/beamacademy-index.html</files>
  <action>
    Ensure handlePayNow has adequate console logging for debugging:
    
    1. Log the payload being sent (already exists - verify it works)
    2. Log the response from the server
    3. Log any errors with full details
    
    The existing code already has some logging. Verify:
    - console.log statements are in place
    - Error messages include the actual error for debugging
    
    This helps diagnose any issues during the user verification step.
  </action>
  <verify>
    - Console logs exist for payload, response, and errors
    - Browser console will show useful debugging info
  </verify>
  <done>Debugging logs in place for payment flow</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Frontend payment flow verified and ready for end-to-end testing</what-built>
  <how-to-verify>
    **End-to-end test using Stripe test mode:**
    
    1. Open the deployed site (or local preview)
    2. Scroll to Courses section
    3. Select any package (e.g., click "1 Subject" under Junior tier)
    4. In the form, click "Already Enrolled" to show payment option
    5. Select subjects if prompted
    6. Fill in the form:
       - Parent name: Test Parent
       - Student name: Test Student  
       - Email: your-real-email@example.com
       - Phone: 0400000000
    7. Click "Pay Now & Save 5%"
    
    **Expected behavior:**
    - Button shows loading spinner
    - Page redirects to Stripe Checkout
    - Stripe shows the correct amount with GST line item
    
    **Complete a test purchase:**
    - Use Stripe test card: 4242 4242 4242 4242
    - Any future expiry, any CVC, any billing details
    - Complete the purchase
    - Should redirect to thank-you.html?payment=success
    
    **Check Stripe Dashboard:**
    - Go to https://dashboard.stripe.com/test/payments
    - Verify the test payment appears with correct amount and metadata
  </how-to-verify>
  <resume-signal>Type "Payment flow works end-to-end" or describe the issue encountered</resume-signal>
</task>

</tasks>

<verification>
- [ ] Pay Now button is wired to handlePayNow function
- [ ] Clicking Pay Now triggers API call to create-checkout
- [ ] Loading state displays during redirect
- [ ] Stripe Checkout opens with correct pricing
- [ ] Test purchase completes successfully
- [ ] Success redirect works (thank-you.html)
</verification>

<success_criteria>
- Complete end-to-end test purchase in Stripe test mode
- All pricing tiers/packages create correct checkout sessions
- Payment appears in Stripe Dashboard with correct metadata
</success_criteria>

<output>
After completion, create `.planning/phases/20-payment-fix/20-02-SUMMARY.md`
</output>
