---
phase: 20-payment-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: false

must_haves:
  truths:
    - "STRIPE_SECRET_KEY is configured in Netlify environment"
    - "Stripe function returns valid checkout session URL when called"
    - "Function handles errors gracefully with meaningful messages"
  artifacts:
    - path: "netlify/functions/create-checkout.js"
      provides: "Stripe checkout session creation"
      exports: ["handler"]
  key_links:
    - from: "netlify/functions/create-checkout.js"
      to: "Stripe API"
      via: "stripe.checkout.sessions.create"
      pattern: "stripe\.checkout\.sessions\.create"
---

<objective>
Verify Netlify environment configuration and test Stripe function endpoint

Purpose: Ensure the backend Stripe integration is working before connecting the frontend
Output: Confirmed working Stripe function that creates checkout sessions
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@netlify/functions/create-checkout.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify Stripe function code and dependencies</name>
  <files>netlify/functions/create-checkout.js, package.json</files>
  <action>
    Review the existing create-checkout.js function to confirm:
    1. Stripe package is properly imported
    2. STRIPE_SECRET_KEY env var check exists
    3. Correct pricing logic for all tier/package combinations
    4. Proper error handling with meaningful messages
    5. CORS headers if needed for cross-origin calls
    
    Check package.json has stripe dependency installed.
    
    Document any code issues found that need fixing.
  </action>
  <verify>
    - `cat netlify/functions/create-checkout.js` shows complete handler
    - `cat package.json` shows stripe dependency
    - No obvious code bugs in checkout logic
  </verify>
  <done>Function code reviewed and confirmed ready for testing</done>
</task>

<task type="auto">
  <name>Task 2: Test Stripe function locally with netlify dev</name>
  <files>None (testing only)</files>
  <action>
    Start Netlify dev server and test the function endpoint:
    
    1. Run `netlify dev` (or `npx netlify dev`) in the project directory
    2. Use curl to test the endpoint with a valid payload:
    
    ```bash
    curl -X POST http://localhost:8888/.netlify/functions/create-checkout \
      -H "Content-Type: application/json" \
      -d '{"tier":"Junior","package":"1 Subject","subjects":["Maths"],"parentName":"Test Parent","studentName":"Test Student","email":"test@example.com","phone":"0400000000"}'
    ```
    
    Expected: Either a valid Stripe checkout URL (if STRIPE_SECRET_KEY is set locally) 
    OR a clear error message about missing env var (which confirms the function runs).
    
    If netlify CLI is not installed, install it first: `npm install -g netlify-cli`
  </action>
  <verify>
    Function responds to POST request (either with checkout URL or clear error about env var)
  </verify>
  <done>Function endpoint is reachable and executes without crashes</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Verified Stripe function code and tested endpoint locally</what-built>
  <how-to-verify>
    1. Confirm Netlify has STRIPE_SECRET_KEY set:
       - Go to https://app.netlify.com
       - Select the beamacademy site
       - Go to Site settings > Environment variables
       - Verify STRIPE_SECRET_KEY exists (should start with sk_test_ or sk_live_)
    
    2. If not set, add it:
       - Get test key from https://dashboard.stripe.com/test/apikeys
       - Add as STRIPE_SECRET_KEY in Netlify environment
    
    3. After env var is confirmed, test the deployed function:
       - Visit the deployed site
       - Open browser console (F12)
       - Run this test (replace YOUR_SITE with actual domain):
       
       ```javascript
       fetch('/.netlify/functions/create-checkout', {
         method: 'POST',
         headers: { 'Content-Type': 'application/json' },
         body: JSON.stringify({
           tier: 'Junior',
           package: '1 Subject',
           subjects: ['Maths'],
           parentName: 'Test',
           studentName: 'Test Student',
           email: 'test@example.com',
           phone: '0400000000'
         })
       }).then(r => r.json()).then(console.log)
       ```
       
       Expected: `{ url: "https://checkout.stripe.com/..." }`
  </how-to-verify>
  <resume-signal>Type "STRIPE_SECRET_KEY confirmed and function returns checkout URL" or describe the issue</resume-signal>
</task>

</tasks>

<verification>
- [ ] create-checkout.js has proper Stripe integration code
- [ ] package.json includes stripe dependency
- [ ] Function runs without crashing
- [ ] STRIPE_SECRET_KEY is configured in Netlify
- [ ] Function returns valid checkout session URL
</verification>

<success_criteria>
- Stripe function creates checkout sessions successfully
- Environment variable is properly configured
- Function handles all tier/package combinations from pricing grid
</success_criteria>

<output>
After completion, create `.planning/phases/20-payment-fix/20-01-SUMMARY.md`
</output>
